# UpdateHubspotCompanies - Collection of AWS Lambdas

This is based off a sample template for AWS - Below is an explanation of the repo structure:

```bash
.
├── README.md                   <-- This instruction file
├── event.json                  <-- Test event to call the Lambda with.
├── example.ini                 <-- Example file for including environment variables in tests.
├── .gitignore                  <-- gitignore for the repo.
├── downloadCustomers           <-- Source code for a lambda function
│   ├── main.py                 <-- Lambda function code
│   └── requirements.txt        <-- Lambda function requirements
├── deployment                  <-- Deployment code
│   └── terraform               <-- Terraform scripts
│       ├── iam.tf              <-- IAM Roles and Policies
│       ├── main.tf             <-- Starting point for Terraform
│       ├── providers.tf        <-- Terraform Provider Configuration
│       └── variables.tf        <-- Terraform Variables
├── template.yaml               <-- SAM Template
└── tests                       <-- Unit tests
    └── unit
        └── test_downloadCustomers.py
```

## Requirements

* AWS CLI already configured with Administrator permission
* [Python 3 installed](https://www.python.org/downloads/)
* [Docker installed](https://www.docker.com/community-edition)

## Setup process

### Local development

**Invoking function locally using a local sample payload**

```bash
sam local invoke DaisyCustomerUpload --event event.json
```

**Invoking function locally through local API Gateway**

```bash
sam local start-api
```

## Deployment

Deployment is carried out using [Terraform](terraform.io).

### Terraform

[TODO: Terraform setup script]

Ensure your AWS Credentials file has a user specified that has permissions to write to the S3 bucket and DynamoDB Table.

Navigate to the `terraform` folder and initialise Terraform
```text
terraform init
```

Plan the Terraform to see what will be created.
```text
terraform plan
```

Apply the Terraform to create the infrastructure.
```text
terraform apply
```

## Fetch, tail, and filter Lambda function logs

To simplify troubleshooting, SAM CLI has a command called sam logs. sam logs lets you fetch logs generated by your Lambda function from the command line. In addition to printing the logs on the terminal, this command has several nifty features to help you quickly find the bug.

`NOTE`: This command works for all AWS Lambda functions; not just the ones you deploy using SAM.

```bash
sam logs -n DaisyCustomerUpload --stack-name aws --tail
```

You can find more information and examples about filtering Lambda function logs in the [SAM CLI Documentation](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-logging.html).

## Testing

Next, we install test dependencies and we run `pytest` against our `tests` folder to run our initial unit tests:

```bash
pip install pytest pytest-mock --user
python -m pytest tests/ -v
```

## Cleanup

In order to delete our Serverless Application recently deployed you can use the following AWS CLI Command:

```bash
aws cloudformation delete-stack --stack-name aws
```

### Step-through debugging

* **[Enable step-through debugging docs for supported runtimes](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-using-debugging.html)**

Next, you can use AWS Serverless Application Repository to deploy ready to use Apps that go beyond hello world samples and learn how authors developed their applications: [AWS Serverless Application Repository main page](https://aws.amazon.com/serverless/serverlessrepo/)

# Appendix

## Building the project

[AWS Lambda requires a flat folder](https://docs.aws.amazon.com/lambda/latest/dg/lambda-python-how-to-create-deployment-package.html) with the application as well as its dependencies in  deployment package. When you make changes to your source code or dependency manifest,
run the following command to build your project local testing and deployment:

```bash
sam build
```

If your dependencies contain native modules that need to be compiled specifically for the operating system running on AWS Lambda, use this command to build inside a Lambda-like Docker container instead:
```bash
sam build --use-container
```

By default, this command writes built artifacts to `.aws-sam/build` folder.

## SAM and AWS CLI commands

All commands used throughout this document

```bash
# Generate event.json via generate-event command
sam local generate-event apigateway aws-proxy > event.json

# Invoke function locally with event.json as an input
sam local invoke HelloWorldFunction --event event.json

# Run API Gateway locally
sam local start-api

# Create S3 bucket
aws s3 mb s3://BUCKET_NAME

# Package Lambda function defined locally and upload to S3 as an artifact
sam package \
    --output-template-file packaged.yaml \
    --s3-bucket REPLACE_THIS_WITH_YOUR_S3_BUCKET_NAME

# Deploy SAM template as a CloudFormation stack
sam deploy \
    --template-file packaged.yaml \
    --stack-name aws \
    --capabilities CAPABILITY_IAM

# Describe Output section of CloudFormation stack previously created
aws cloudformation describe-stacks \
    --stack-name aws \
    --query 'Stacks[].Outputs[?OutputKey==`HelloWorldApi`]' \
    --output table

# Tail Lambda function Logs using Logical name defined in SAM Template
sam logs -n HelloWorldFunction --stack-name aws --tail
```

